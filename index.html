<!DOCTYPE html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Der Wahre Walter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="canonical" href="https://broesmel.github.io/der-wahre-walter/" />
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#ffffff" />
  <link rel="shortcut icon" href="public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="public/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="public/apple-touch-icon.png">
  <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="public/android-chrome-192x192.png">
  <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="public/android-chrome-512x512.png">
  <link rel="favicon-16x16" type="image/png" sizes="16x16" href="public/favicon-16x16.png">
  <link rel="favicon-32x32" type="image/png" sizes="16x16" href="public/favicon-32x32.png">
  <meta name="pwa-capable" content="yes">
</head>
<body>
<!-- 
<p class="bold" id="spruch"> ich bin der wahre walter. </p> hehe
<button onclick="we_want_change()"> change something </button>
--> 

<div class="container" style="padding: 32px;">
      <div class="card text-left">
        <div class="card-body">
          <div class="card-text" id="current_card"></div>

          <div class="row" style="padding-top:16px">
            <div class="col">
              <button type="button" class="btn prev" onclick = "LoadPrev()">
                <code> <-prev </code>
              </button>
            </div>
            <div class="col text-center">
              <button type="button" class="btn flip btn-light" onclick ="flip_card()" disabled style="display:none">
                <code> ⭞flip⭜ </code>
              </button> <!-- ⟳ -->
            </div>
            <div class="col">
              <button type="button" class="btn next float-right" onclick="LoadNext()">
                <code> next-> </code>
              </button>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>

<script>
  // PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register(
      `./service-worker.js`, {
        scope: `./`
      }
    )
  }
</script>

<script>
// helper scripts for cookies
function setCookie(name,value,days) {
  var expires = "";
  if (days) {
    var date = new Date();
    date.setTime(date.getTime() + (days*24*60*60*1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "")  + expires + "; path=/;SameSite=None;secure";
}
function getCookie(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for(var i=0;i < ca.length;i++) {
    var c = ca[i];
    while (c.charAt(0)==' ') c = c.substring(1,c.length);
    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
  }
  return null;
}
function eraseCookie(name) {
  document.cookie = name+'=; Max-Age=-99999999;';  
}

</script>


<script charset="utf-8">
// loading in the cards
var request = new XMLHttpRequest();
   request.open("GET", "./walter_cards.json", false);
   request.send(null)
   var json_data = JSON.parse(request.responseText);

// console.log(json_data);
var cards = json_data["cards"];

viewed_nrs = [];
prev_nr = -1;
current_nr = -1;
card_nrs = [];

function ShuffleCards() {
  // shuffle the card_nrs and reset the viewed_nrs, save this state
  card_nrs = [];
  for(var k in cards) card_nrs.push(k);
  shuffle(card_nrs);
  viewed_nrs = [];
  prev_nr = -1;
  current_nr = -1;
  setHistoryCookie();
}

// initial shuffle of the cards or loading of the order in the cookie
function LoadOrShuffle() {
  hist = getCookie("history");
  if(hist == null) {
    // no cookie exists, so 
    ShuffleCards()
  }
  else {
    hist = JSON.parse(hist);
    viewed_nrs = hist["viewed_nrs"];
    current_nr = hist["current_nr"];
    card_nrs   = hist["card_nrs"];
  }
  // console.log(viewed_nrs);
  // console.log(current_nr);
  // console.log(card_nrs);
  if(current_nr == -1) LoadNext();
  else render_card(current_nr);
}

LoadOrShuffle(); // call this on page load 

// wrapper to save all necessary data to cookie
function setHistoryCookie() {
  var history = {
    "viewed_nrs": viewed_nrs,
    "current_nr": current_nr,
    "card_nrs": card_nrs
  }
  setCookie("history", JSON.stringify(history), 9999);
}


function LoadPrev(card) {
  prev_nr = current_nr;
  
  if(viewed_nrs.length <= 0) {
    alert("Es gibt noch keine abgelegten Fichen.");
    return;
  }
  if(current_nr != -1) card_nrs.push(current_nr);
  current_nr = viewed_nrs.pop();
  // skip duplicates
  if (prev_nr == current_nr) current_nr = card_nrs.pop();
  
  render_card(current_nr);

  // console.log(viewed_nrs);
  // console.log(current_nr);
  // console.log(card_nrs);
  
}

function LoadNext() {
  prev_nr = current_nr;

  if(card_nrs.length <= 0) {
    alert("Der Fichen-Stapel ist leer. Er wurde erneut gemischt. Ihr könnt weiterspielen. Wählt die Aussagen die ihr noch nicht behandelt habt.");
    ShuffleCards();
    return;
  }
  if(current_nr != -1) viewed_nrs.push(current_nr);
  current_nr = card_nrs.pop();
  // skip duplicates
  if (prev_nr == current_nr) current_nr = card_nrs.pop();

  render_card(current_nr);

  // console.log(viewed_nrs);
  // console.log(current_nr);
  // console.log(card_nrs);

}



function render_card(card_nr) {
  var cc = document.getElementById("current_card");
  var flip_btn = document.getElementsByClassName("flip")[0];
  

  if ("gender" in cards[card_nr]) {
    cc.innerHTML = `<p class="bold text-center" style="margin-bottom: 16px;">
      ${cards[card_nr]["gender"]}\n
    </p>
    `;
    flip_btn.disabled = false;
    flip_btn.style.display = "";
  }
  else  {
    cc.innerHTML = `<p class="bold" align="center" style="padding-top: 16px; style="margin-bottom: 16px; visibility: hidden;"> \n</p>`;
    flip_btn.disabled = true;
    flip_btn.style.display = "none";
  }

  cc.innerHTML += `
  <div class="card_nr text-right float-right">${card_nr}</div>
  <ol>
    <li> ${spanify_walter(cards[card_nr][1])} </li>
    <li> ${spanify_walter(cards[card_nr][2])} </li>
    <li> ${spanify_walter(cards[card_nr][3])} </li>
  </ol>
  `;
  setHistoryCookie();
}


// render the flipside of a gendered card
function flip_card() {
  // not a gendered card, abort
  if(current_nr == -1 || !("gender" in cards[current_nr]) ) return; 

  prev_nr = current_nr;
  // update current_nr to match flipside
  current_nr = cards[current_nr]["flip"];
  // only do the stuff below once
  if(prev_nr != current_nr) {
    // if flipside in the stapel, remove it from there
    if(current_nr in card_nrs) {
      card_nrs = card_nrs.filter(function(value, index, arr){ return value != current_nr;});
    }
    // if flipside not in viewed, add it to there
    if(!(current_nr in viewed_nrs)) {
      viewed_nrs.push(current_nr);
    }
  }

  render_card(current_nr);

}


function spanify_walter(string) {
  var result = string.replace(/(WALTER[A-Z]*)/gi, function(match) { return `<span class="walter">${match}</span>`});
  return result;
}


/**
 * Shuffles array in place. ES6 version
 * @param {Array} a items An array containing the items.
 */
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
</script>

